<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width"/>
	<title>Array randomization tests</title>
	<script src="../test-framework/tests.common.js"></script>
	
	<script>Liby = {}</script>
	<script src="../../modules/array-randomize.js"></script>
</head>
<body>
<script>
// reference implementations
;(function(){

var Math_random = Math.random

Liby.ArrayRandom.shuffleSwap = function ()
{
	for (var i = 0, il = this.length; i < il; i++)
	{
		var j = (Math_random() * il) >> 0
		var v = this[j]
		this[j] = this[i]
		this[i] = v
	}
	
	return this
}

Liby.ArrayRandom.shuffleSort = function ()
{
	return this.sort(function (a, b) { return 0.5 - Math_random() })
}

})();


Tests.test(function (t)
{
	Array.prototype.random = Liby.ArrayRandom.random
	
	t.test('random', function (t)
	{
		Array.prototype.shuffle = function () { return this } // noop
		
		var array = [1, 2, 3, 4, 5]
		
		t.like(array.random(0), [], 'zero')
		t.eq(array.random(1).length, 1, 'one length')
		t.type(array.random(1)[0], 'number', 'one value')
		t.eq(array.random(array.length).length, array.length, 'full length')
		t.eq(array.random(array.length + 1).length, array.length, 'greater then length')
		t.like(array.random(-1), [], 'less then zero')
		t.eq(array.random(2.5).length, 2, 'float point')
	})
	
	
	t.test('shuffle', function (t)
	{
		function declension (n)
		{
			var ary = []
			for (var i = 0; i < n; i++)
				ary[i] = i
			
			var seen = []
			for (var i = 0; i < n * n; i++)
				seen[i] = 0
			
			
			var repeat = n * 100000
			
			for (var i = 0; i < repeat; i++)
			{
				var res = ary.slice().shuffle()
				for (var j = 0; j < n; j++)
					seen[j * n + res[j]]++
			}
			
			
			var mid = repeat / n
			
			var sum = 0
			for (var i = 0; i < n * n; i++)
			{
				var diff = seen[i] / mid - 1
				sum += diff * diff
			}
			
			return sum / n
		}
		
		function run (t, method, limit)
		{
			Array.prototype.shuffle = Liby.ArrayRandom[method]
			
			t.like([].shuffle(), [], 'empty')
			t.like([1].shuffle(), [1], 'single')
			t.like([1, 2].shuffle().sort(), [1, 2], 'duo')
			t.like([1, 2, '3', 'abc', 4.0, [], {}].shuffle().sort(), [1, 2, '3', 'abc', 4.0, [], {}].sort(), 'preserve structures')
			
			t.time('time')
			t.lt(declension(1), limit, 'for 1')
			t.lt(declension(2), limit, 'for 2')
			t.lt(declension(5), limit, 'for 5')
			t.lt(declension(10), limit, 'for 10')
			t.timeEnd('time')
		}
		
		t.test('shuffleHard()', function (t)
		{
			run(t, 'shuffleHard', 0.01)
		})
		
		t.test('shuffle()', function (t)
		{
			run(t, 'shuffle', 0.01)
		})
		
		
		
		// reference implementations
		
		t.test('shuffleSwap()', function (t)
		{
			run(t, 'shuffleSwap', 1)
		})
		
		t.test('shuffleSort()', function (t)
		{
			run(t, 'shuffleSort', 10)
		})
	})
	
})
</script>
</body>
</html>