<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru" id="event-page" class="loading finans-bank-forum-2 status-archive">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<link rel="stylesheet" href="tests.css" type="text/css"/>
	<title>EventTarget tests</title>
</head>
<body>

<button id="test-node-1">test node 1</button>
<button id="test-node-2">test node 2</button>

<!--[if lte IE 7]><script type="text/javascript" src="../programica/fixes/trident3.js"></script><![endif]-->
<!--[if IE 8]><script type="text/javascript" src="../programica/trident4.js"></script><![endif]-->
<script type="text/javascript" src="../programica/fixes/log.js"></script>
<script type="text/javascript" src="../programica/init.js"></script>
<script type="text/javascript" src="../programica/prototype.js"></script>
<script type="text/javascript" src="../programica/class.js"></script>
<script type="text/javascript" src="../modules/event-target.js"></script>

<script type="text/javascript" src="tests.js"></script>
<script type="text/javascript">
	window.addEventListener('load', function () {
	tests.plan(19*4)
	// tests.skip([3,4,5,6,12])
	if (/IE [67]/.test(tests.ua))
		tests.skip([13, 32])
	
	function run (kind, type, node)
	{
		var calls = 0, e, exception = null
		function handler (e) { calls++ }
		
		try {
		
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		e.preventDefault()
		tests.eq(e.defaultPrevented, undefined, 'single preventDefault() does not set defaultPrevented')
		
		tests.log('testing node "' + node.nodeName + '" with event type "' + type + '"')
		tests.eq(typeof node.addEventListener, 'function', 'node.addEventListener is a function')
		node.addEventListener(type, handler,false)
		tests.eq(calls, 0, 'addEventListener does not call handler')
		
		e = document.createEvent(kind)
		tests.eq(typeof e, 'object', 'document.createEvent returns an object')
		e.abcdef = 'abcdef'
		tests.eq(e.abcdef, 'abcdef', 'event object supports custom fields')
		
		tests.eq(typeof e.initEvent, 'function', 'event.initEvent is a function')
		e.initEvent(type, true, true)
		tests.eq(e.type, type, 'event.initEvent sets event type correctly')
		
		tests.eq(typeof node.dispatchEvent, 'function', 'node.dispatchEvent is a function')
		node.dispatchEvent(e)
		tests.eq(calls, 1, 'dispatchEvent does call handler')
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		node.dispatchEvent(e)
		tests.eq(calls, 2, 'custom handler called ok twice')
		
		node.removeEventListener(type, handler, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		node.dispatchEvent(e)
		tests.eq(calls, 2, 'removeEventListener works fine')
		
		node.addEventListener(type, handler, false)
		node.addEventListener(type, handler, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		node.dispatchEvent(e)
		tests.eq(calls, 3, 'second addEventListener ignored')
		
		var order = []
		node.addEventListener(type, function () { order.push('first') }, false)
		node.addEventListener(type, function () { order.push('second') }, false)
		node.addEventListener(type, function () { order.push('third') }, false)
		node.addEventListener(type, function () { order.push('fourth') }, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		node.dispatchEvent(e)
		tests.eqarr(order, ['first', 'second', 'third', 'fourth'], 'call order preserved')
		
		var event1, event2, event3
		node.addEventListener(type, function (e) { event1 = e; e.abc++ }, false)
		node.addEventListener(type, function (e) { event2 = e; e.abc++ }, false)
		node.addEventListener(type, function (e) { event3 = e; e.abc++ }, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		e.abc = 0
		node.dispatchEvent(e)
		tests.eqarr([event1, event2, event3], [e, e, e], 'all listeners got the same event object')
		tests.eqarr(e.abc, 3, 'listeners can write custom fields')
		
		function prevent (e) { e.preventDefault() }
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		tests.eq(node.dispatchEvent(e), true, 'preventDefault() not invoked')
		node.addEventListener(type, prevent, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		tests.eq(node.dispatchEvent(e), false, 'preventDefault() invoked')
		node.removeEventListener(type, prevent, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		tests.eq(node.dispatchEvent(e), true, 'preventDefault() not invoked')
		
		} catch (ex) { exception = ex }
		tests.eq(exception, null, 'no exceptions was throwed')
	}
	
	run('Event', 'hide', document.getElementById('test-node-1'))
	run('MouseEvent', 'click', document.getElementById('test-node-2'))
	
	var T = Class('T')
	T.prototype.initialize = function () { this.nodeName = 'object' }
	T.mixIn(EventTarget)
	run('Event', 'hide', new T())
	run('MouseEvent', 'click', new T())
	
	tests.done()
	}, false)
</script>
</body>
</html>
