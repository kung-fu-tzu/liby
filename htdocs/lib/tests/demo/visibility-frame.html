<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=320"/>
	<title>Visibility frame demo</title>
	
	
	<!--[if lte IE 7]><script type="text/javascript" src="../../core/fixes/trident3.js"></script><![endif]-->
	<!--[if gte IE 8]><script type="text/javascript" src="../../core/fixes/trident4.js"></script><![endif]-->
	<script src="../../core/prototype.js" type="text/javascript"></script>
	<script src="../../modules/log.js" type="text/javascript"></script>
	<script src="../../modules/cosy.js" type="text/javascript"></script>
	<script src="../../modules/element.js" type="text/javascript"></script>
	<script src="../../modules/url-encode.js" type="text/javascript"></script>
	
	<script src="../../modules/gridder.js" type="text/javascript"></script>
	<script src="../../modules/visibility-frame.js" type="text/javascript"></script>
	<script src="../../modules/event-driven.js" type="text/javascript"></script>
	<script src="../../modules/moveable.js" type="text/javascript"></script>
	
	<style type="text/css">
		html, body { margin: 0; padding: 0; overflow: hidden; }
		#boxes { position: absolute; left: 0; top: 0; width: 100%; height: 100%; }
		#boxes div { position: absolute; z-index: 1; left: 0; top: 0; background-color: #888; /*opacity: 0.25;*/ }
		#boxes div.visible { background-color: #6d4; /*opacity: 0.75;*/ }
		
		#boxes.transparent div { opacity: 0.25; }
		#boxes.transparent div.visible { opacity: 0.75; }
		
		#frame { position: absolute; z-index: 2; left: 0; top: 0; width: 400px; height: 300px; border: 1px solid #555; cursor: move; }
		
		#stat { position: absolute; z-index: 3; right: 25px; top: 25px; width: 220px; text-align: center;  background-color: #fff; overflow: hidden; }
	</style>
</head>
<body>
<div id="stat">Â </div>
<div id="boxes"></div>
<div id="frame"></div>
<script type="text/javascript">
$.onload(function ()
{
	var count = 25, transparent = true
	
	var options = UrlEncode.parse(window.location.hash.substr(1))
	if ('count' in options)
		count = options.count
	if ('transparent' in options)
		transparent = options.transparent !== 'false'
	
	
	
	var boxesRoot = $('boxes')
	
	if (transparent)
		boxesRoot.className += ' transparent'
	
	
	var statNode = $('stat').firstChild
	
	
	var boxes = []
	
	var rw = boxesRoot.offsetWidth, rh = boxesRoot.offsetHeight,
		mw = rw / 5, mh = rh / 5, min = 25,
		random = Math.random
	for (var i = 0; i < count; i++)
	{
		var w = (random() * mw + min) >> 0,
			h = (random() * mh + min) >> 0,
			x = (random() * (rw - w)) >> 0,
			y = (random() * (rh - h)) >> 0
		
		var box = boxes[i] = document.createElement('div')
		var s = box.style
		s.left = x + 'px'
		s.top = y + 'px'
		s.width = w + 'px'
		s.height = h + 'px'
		
		boxesRoot.appendChild(box)
	}
	
	var frameNode = $('frame')
	
	var frame = new VisibilityFrame()
	frame.gridder.maxSteps = count * 10
	frame.setNodes(boxes)
	frame.setFrame(frameNode.offsetWidth, frameNode.offsetHeight)
	frame.onmove = function (show, hide)
	{
		var begin = new Date()
		
		for (var i = 0; i < hide.length; i++)
			hide[i].node.className = ''
		
		for (var i = 0; i < show.length; i++)
			show[i].node.className = 'visible'
		
		statNode.nodeValue = 'show: ' + show.length + ', hide: ' + hide.length + ', time: ' + (new Date() - begin) + 'ms'
	},
	frame.moveTo(frameNode.offsetLeft, frameNode.offsetTop)
	
	var m = new Moveable()
	m.bind(frameNode)
	
	var frameX = 0, frameY = 0
	function movestart (e)
	{
		frameX = frameNode.offsetLeft
		frameY = frameNode.offsetTop
	}
	
	function move (e)
	{
		var x = frameX + e.data.dx,
			y = frameY + e.data.dy
		
		frameNode.style.left = x + 'px'
		frameNode.style.top = y + 'px'
		frame.moveTo(x, y)
	}
	
	m.addEventListener('movestart', movestart, false)
	m.addEventListener('move', move, false)
})
</script>
</body>
</html>