<!DOCTYPE html>
<html lang="ru">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=320"/>
	<title>Partial EventTarget tests</title>
	
	<!--[if lte IE 7]><script type="text/javascript" src="../core/fixes/trident3.js"></script><![endif]-->
	<!--[if gte IE 8]><script type="text/javascript" src="../core/fixes/trident4.js"></script><![endif]-->
	
	<script src="tests.common.js" type="text/javascript"></script>
</head>
<body>

<button id="test-node-1">test node 1</button>
<button id="test-node-2">test node 2</button>

<script type="text/javascript">
Tests.test(function (t)
{
	function run (t, kind, type, node)
	{
		var calls = 0, e, exception = null
		function handler (e) { calls++ }
		
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		e.preventDefault()
		t.eq(e.defaultPrevented, undefined, 'single preventDefault() does not set defaultPrevented')
		
		t.log('testing node "' + node.nodeName + '" with event type "' + type + '"')
		t.eq(typeof node.addEventListener, 'function', 'node.addEventListener is a function')
		node.addEventListener(type, handler, false)
		t.eq(calls, 0, 'addEventListener does not call handler')
		
		e = document.createEvent(kind)
		t.eq(typeof e, 'object', 'document.createEvent returns an object')
		e.abcdef = 'abcdef'
		t.eq(e.abcdef, 'abcdef', 'event object supports custom fields')
		
		t.eq(typeof e.initEvent, 'function', 'event.initEvent is a function')
		e.initEvent(type, true, true)
		t.eq(e.type, type, 'event.initEvent sets event type correctly')
		
		calls = 0
		t.eq(typeof node.dispatchEvent, 'function', 'node.dispatchEvent is a function')
		node.dispatchEvent(e)
		t.eq(calls, 1, 'dispatchEvent does call handler')
		
		calls = 0
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		node.dispatchEvent(e)
		t.eq(calls, 1, 'handler called ok twice')
		
		calls = 0
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		document.addEventListener(type, handler, false)
		node.dispatchEvent(e)
		t.eq(calls, 2, 'document handler called ok')
		
		calls = 0
		node.removeEventListener(type, handler, false)
		document.removeEventListener(type, handler, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		node.dispatchEvent(e)
		t.eq(calls, 0, 'removeEventListener works fine')
		
		calls = 0
		node.addEventListener(type, handler, false)
		node.addEventListener(type, handler, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		node.dispatchEvent(e)
		t.eq(calls, 1, 'second addEventListener ignored')
		
		var order = []
		node.addEventListener(type, function () { order.push('first') }, false)
		node.addEventListener(type, function () { order.push('second') }, false)
		node.addEventListener(type, function () { order.push('third') }, false)
		node.addEventListener(type, function () { order.push('fourth') }, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		node.dispatchEvent(e)
		t.like(order, ['first', 'second', 'third', 'fourth'], 'call order preserved')
		
		var event1, event2, event3
		node.addEventListener(type, function (e) { event1 = e; e.abc++ }, false)
		node.addEventListener(type, function (e) { event2 = e; e.abc++ }, false)
		node.addEventListener(type, function (e) { event3 = e; e.abc++ }, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		e.abc = 0
		node.dispatchEvent(e)
		t.eq(event1, e, 'first listener got the same event object')
		t.eq(event2, e, 'second listener got the same event object')
		t.eq(event3, e, 'third listener got the same event object')
		t.eq(e.abc, 3, 'listeners can write custom fields')
		
		function prevent (e) { e.preventDefault() }
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		t.eq(node.dispatchEvent(e), true, 'preventDefault() not invoked')
		node.addEventListener(type, prevent, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		t.eq(node.dispatchEvent(e), false, 'preventDefault() invoked')
		node.removeEventListener(type, prevent, false)
		e = document.createEvent(kind)
		e.initEvent(type, true, true)
		t.eq(node.dispatchEvent(e), true, 'preventDefault() not invoked')
	}
	
	
	t.test('Event: hide on node', function (t)
	{
		run(t, 'Event', 'hide', document.getElementById('test-node-1'))
	})
	
	t.test('MouseEvent: click on node', function (t)
	{
		run(t, 'MouseEvent', 'click', document.getElementById('test-node-2'))
	})
})
</script>
</body>
</html>