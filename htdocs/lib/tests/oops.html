<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=320"/>
	<title>Oops tests</title>
	
	<script src="tests.common.js" type="text/javascript"></script>
	<!--# if expr="$HTTP_USER_AGENT = /Opera/(9|10)\.|Safari/" -->
	<script type="text/javascript" src="../core/fixes/onerror.js"></script>
	<!--# endif -->
	<script type="text/javascript" src="../modules/oops.js"></script>
</head>
<body>
<script type="text/javascript">
Tests.test(function (t)
{
	var reports = []
	window.Tracker = { track: function (c, a, l, v) { reports.push({category: c, action: a, label: l, value: v}) } }
	
	t.test('check for existence', function (t)
	{
		t.ok(Oops, 'global Oops object')
	})
	
	t.test('simple exception handling', function (t)
	{
		t.expect(4)
		
		function setTimeout ()
		{
			// Oops may had been disabled by other async tests
			// so re-enabling it
			Oops.enable()
			
			throw new Error('setTimeout')
		}
		window.setTimeout(setTimeout, 10)
		
		
		function setInterval ()
		{
			Oops.enable()
			
			clearInterval(intervalTimer)
			throw new Error('setInterval')
		}
		var intervalTimer = window.setInterval(setInterval, 10)
		
		function addEventListener (e)
		{
			Oops.enable()
			t.eq(e.type, 'load', 'event type')
			throw new Error('addEventListener')
		}
		var node = document.body.appendChild(document.createElement('iframe'))
		node.addEventListener('load', addEventListener, false)
		node.src = '/'
		
		
		function check ()
		{
			var all = []
			for (var i = 0; i < reports.length; i++)
				all[i] = reports[i].label
			all = all.join('\n')
			
			t.gte(all.indexOf('setTimeout'), 0, 'setTimeout()')
			t.gte(all.indexOf('setInterval'), 0, 'setInterval()')
			t.gte(all.indexOf('addEventListener'), 0, 'addEventListener()')
		}
		t.async(check, 100)
	})
	
	t.test('log() and error()', function (t)
	{
		Oops.log('logging')
		var report = reports[reports.length-1]
		t.eq(report.category, 'Oops')
		t.eq(report.action, 'log')
		t.eq(report.label, 'logging')
		
		Oops.error('erroring')
		var report = reports[reports.length-1]
		t.eq(report.category, 'Oops')
		t.eq(report.action, 'error')
		t.eq(report.label, 'erroring')
		
		Oops.time('timing', 12345)
		var report = reports[reports.length-1]
		t.eq(report.category, 'Oops')
		t.eq(report.action, 'time')
		t.eq(report.label, 'timing')
		t.eq(report.value, 12345)
	})
	
	t.test('maybeEnable', function (t)
	{
		Oops.disable()
		t.no(Oops.enabled, 'disabled')
		
		
		t.log('clearing Oops cookie')
		document.cookie = 'Oops=; expires=Sun, 28 Feb 2010 16:53:02 GMT'
		
		Oops.maybeEnable()
		t.ok(Oops.enabled, 'Oops is enabled')
		
		Oops.disable()
		t.no(Oops.enabled, 'disabled')
		
		
		t.log('setting Oops=disabled cookie')
		document.cookie = 'Oops=disabled'
		
		Oops.maybeEnable()
		t.no(Oops.enabled, 'Oops is still disabled')
		
		t.log('force enable Oops')
		Oops.enable()
		t.ok(Oops.enabled, 'Oops is now enabled')
		
		
		Oops.disable()
		t.no(Oops.enabled, 'disabled')
		
		t.log('clearing Oops cookie')
		document.cookie = 'Oops=; expires=Sun, 28 Feb 2010 16:53:02 GMT'
	})
})
</script>
</body>
</html>