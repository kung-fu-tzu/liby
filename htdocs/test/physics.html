<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<title>Капнем капельку физики</title>
	<script type="text/javascript" src="/lib/Programica.js"></script>
	<style>
		canvas { border: 1px solid #eee; display: block; cursor: default;/*width: 500px; height: 150px;*/ }
		/*canvas { -webkit-transform: rotate(3deg); cursor: pointer; }*/
	</style>
</head>
<body>
	<canvas id="viewport" width="1000" height="400"></canvas>
	
	<script>
	
	var can = $('viewport')
	var ctx = can.getContext('2d')
	
	var width = can.width
	var height = can.height
	
	var shapes =
	[
		{x: 460, y: 140, color: 'rgb(255,128,0)', m: 150, a: 0, va: 0.02, points: [-20,-10,  15,-30,  10,10]},
		{x: 300, y: 160, color: 'rgb(128,200,0)', m: 200, a: 1, va: 0.02, points: [-30,-50,  -60,50,  60,50, 30,-50]}
	]
	
	function initShapes (shapes)
	{
		var a, pts
		for (var i = 0, il = shapes.length; i < il; i++)
		{
			a = shapes[i]
			
			a.vx = a.vx || 0
			a.vy = a.vy || 0
			a.va = a.va || 0
			
			a.pointsA = []
			
			pts = a.points
			for (var j = 0; j < pts.length; j+=2)
			{
				// radius vector (RV) length
				var c = Math.sqrt(pts[j] * pts[j] + pts[j+1] * pts[j+1])
				// remember RV
				a.pointsA.push(c)
				// remember RV angle
				var angle = Math.acos(pts[j]/c)
				a.pointsA.push(pts[j+1] >= 0 ? angle : (Math.PI * 2 - angle) )
			}
		}
	}
	
	initShapes(shapes)
	
	ctx.strokeStyle = 'rgb(0, 0, 0)'
	
	function compute ()
	{
		
	}
	
	function rotateShape (shape, angle)
	{
		var pts, ptsA, angle
		shape.points = pts = []
		ptsA = shape.pointsA
		
		for (var j = 0; j < ptsA.length; j+=2)
		{
			// calculate new RA angle
			na = ptsA[j+1] + angle
			
			// calculate new point coordinates
			pts.push(ptsA[j] * Math.cos(na))
			pts.push(ptsA[j] * Math.sin(na))
		}
	}
	
	function translateShape (shape, x, y)
	{
		var pts = shape.points
		
		for (var j = 0; j < pts.length; j+=2)
		{
			// calculate new point coordinates
			pts[j] += x
			pts[j+1] += y
		}
	}
	
	function move ()
	{
		var a
		for (var i = 0, il = shapes.length; i < il; i++)
		{
			a = shapes[i]
			
			a.a += a.va
			a.x += a.vx
			a.y += a.vy
			
			rotateShape(a, a.a)
			translateShape(a, a.x, a.y)
		}
	}
	
	function freeze ()
	{
		
	}
	
	function draw ()
	{
		ctx.clearRect(0, 0, width, height)
		//ctx.fillStyle = 'rgba(0,0,0,0.1)'
		//ctx.fillRect(0, 0, 1000, 300)
		
		var a, points
		for (var i = 0, il = shapes.length; i < il; i++)
		{
			a = shapes[i]
			
			ctx.save()
			
			ctx.strokeStyle = a.color
			ctx.fillStyle = a.color
			
			//ctx.translate(a.x, a.y)
			//ctx.rotate(a.a)
			
			ctx.beginPath()
			points = a.points
			ctx.moveTo(points[0], points[1])
			for (var j = 0, jl = a.points.length; j < jl; j+=2)
			{
				ctx.lineTo(points[j], points[j+1])
			}
			ctx.lineTo(points[0], points[1])
			ctx.stroke()
			
			ctx.beginPath()
			//ctx.moveTo(0, 0)
			ctx.arc(0, 0, 2, 0, Math.PI * 2, false)
			ctx.fill()
			
			for (var j = 0, jl = a.points.length; j < jl; j+=2)
			{
				ctx.beginPath()
				//ctx.moveTo(points[0], points[1])
				ctx.arc(points[j], points[j+1], 2, 0, Math.PI * 2, false)
				ctx.fill()
			}
			
			
			ctx.restore()
		}
		
		//shapes[1].rot += 0.1
	}
	
	function loaded ()
	{
		
		//setInterval(compute, 50)
		//compute()
		setInterval(move, 20)
		//setInterval(freeze, 200)
		setInterval(draw, 40)
		
	}
	
	$.onload(loaded)
	</script>
	
</body>
</html>